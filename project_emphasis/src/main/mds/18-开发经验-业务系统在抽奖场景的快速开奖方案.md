# 场景

系统对外投放了一个活动页，通过**抽奖前置注册**的方式进行新用户引流，注册完成后登记这个用户的信息，等特定时间段进行开奖，中奖人数限定在100人内。该如何设计快速的开奖流程呢？

# 用MySQL（废案）

这是最容易想到的方案，当用户点击抽奖后，将用户id、其他信息写入**抽奖用户表**。当抽奖时间到来后，使用定时调度任务或者其他定时方式，随机从表中取100条用户记录，问题是如何保证这个随机性呢？

其实可以通过代码生成一个随机数，匹配抽奖用户表的自增id，通过随机生成+id查询的方式确认中奖用户，但这样每确定一次用户就要查询一次数据库，性能是比较差的。

还有另一种方式，使用rand()函数，再查询时让MySQL给每行记录生成一个随时数，再通排序 + limit的方式确认中奖用户，以下是关键SQL：

```sql
SELECT * FROM 抽奖用户表 ORDER BY RAND() DESC LIMIT 0,100
```

但是抽奖用户表数据量较大的话，RAND()的性能会很差，如果是小流量UV的页面投放是没问题的。

但是用MySQL还有另一个问题：假设活动页投放抽奖这个功能要复用呢？比如今天是在某某小程序投放、下周又打算在某某APP进行投放，难道每次投放都要准备一张抽奖用户表吗？复用一张表的话还得使用**标识字段**来区分每次抽奖，即使标识字段有索引，数据量大的话还是有可能出现**索引选择性差**的问题。

**所以只用MySQL的方案被否决了。**

# 用Redis（最终选型方案）

可别忘了Redis有Set的数据结构，Set既能去重，又能使用spop随机弹出，而且spop还能指定弹出的数量，解决了5个痛点：

1. 防止用户重复抽奖。
2. 防止用户重复中奖。
3. 一次性获取**特定个数**的随机数据。
4. 单线程，不会有线程安全问题。
5. 通过redis的key的不同，实现不同活动的**开奖逻辑复用性**。

大体的流程如下：

1. 在抽奖活动A开始时，活动A来源的新用户ID，会被保存到activity:A:userList这个Key里，它是Set属性的Key，能够保证数据存放的幂等性。
2. 当抽奖时间到来后，使用定时调度任务或者其他定时方式，通过SPOP activity:A:userList 100从随机获取100个用户ID，从而确定中奖人。
3. 通过中奖人ID继续从代码层面走中奖逻辑。

一开始设计这个方案主要有2个待考虑的点：

1. 如果有大数据量的用户抽奖，使用Redis保存用户ID有没有内存空间危机？

   ​	结果评估了一下，存储1000W个抽奖用户的ID，大约700、800MB左右，这个使用量是没压力的。而且后期可以**考虑单独部署一个抽奖Redis集群**。

2. 如果有大数据量的用户抽奖，使用Redis的SPOP性能如何？

   ​	实际测试了一下，也是1000W的量级，单次SPOP 100大约2.5ms，这是完全够用的。